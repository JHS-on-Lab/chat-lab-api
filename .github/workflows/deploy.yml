name: CI/CD - Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 25
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'
          cache: gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 3. Build JAR
      - name: Build with Gradle
        run: ./gradlew clean bootJar --no-daemon

      # 4. AWS OIDC Login
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 5. ECR Login
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 6. Build Docker Image
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} .

      # 7. Tag for ECR
      - name: Tag image
        run: |
          docker tag \
          ${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} \
          ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

      # 8. Push to ECR
      - name: Push image
        run: |
          docker push \
          ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

      # 9. Deploy to EC2 via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            export SPRING_PROFILES_ACTIVE=prod
            export DB_URL=${{ secrets.DB_URL }}
            export DB_USERNAME=${{ secrets.DB_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            export ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
            export ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

            aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

            cd ~/app/chatlab
            
            export IMAGE_TAG=${{ github.sha }}
            docker compose -f docker-compose.api.yml up -d
